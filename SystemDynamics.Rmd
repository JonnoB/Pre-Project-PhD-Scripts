---
title: "Untitled"
author: "Jonathan Bourne"
date: "22 March 2019"
output: html_document
editor_options: 
  chunk_output_type: console
---



```{r}
library(tidyverse)


theta_force <- seq(0,pi/2, 0.05 )


k = 300
dist <- sqrt(2)
force = 60
test <- tibble(Tension = force/sin(theta_force), adjacent = force/tan(theta_force), 
       opposite = force,
       elongation = Tension/k,
       theta_force = theta_force,
       theta_dist = acos(dist/(dist+elongation)),
       theta_diff = theta_force-theta_dist,
       height = sqrt((dist+ elongation)^2- dist^2))

test %>%
  arrange(abs(theta_diff)) %>% slice(1)

ggplot(test, aes(x = theta_force, y = theta_diff))+ geom_point()

```




```{r}
k1<- 2.5
k2 <- 3
F1<- 15
F2<- -25
F3 <- 10

D1 <- 1
D2 <-1.5
Dvect <- seq(0.01, 20, 0.001)

test <-tibble(z = Dvect, DX1 = sqrt(z^2 + D1^2)-D1, DX2 = sqrt(z^2 + D2^2)-D2, Ft1 = k1*DX1, Ft2 = k2*DX2, 
       F1u = Ft1*z/(DX1+D1), F2u = Ft2*z/(DX2+D2), difference = F1u+F2u+F3, min = abs(difference))


ggplot(test, aes(x = z, y = min))+ geom_point()


Fvect <- c(F1,-F3,F2)

test %>% arrange(min) %>% slice(1) %>% pull(z) %>% c(0,.,0) %>%
  tibble(ID  = 1:3, Fvect, height = -. ) %>%
  ggplot(., aes(x = ID, y = height)) + geom_point(size = 5) +
  geom_line()


EdgeNode <- c(1,0,-1,0,0,0,
              0,1,-1,0,0,0,
              0,0,0,1,-1,0,
              0,0,0,1,-1,0,
              0,0,0,0,1,-1,
              0,0,0,1,0,-1,
              0,1,0,0,-1,0
              ) %>% matrix(nrow = 7, byrow = T)

Link <- tibble(EdgeName = 1:7, 
               distance = c(sqrt(2), sqrt(2), sqrt(2), sqrt(2), 1,1, sqrt(2)),
               k = c(5,2,2.5,4,4,3,1))

  C <- matrix(data = 0, nrow = nrow(Link), ncol = nrow(Link))
  diag(C) <- Link$distance

t(EdgeNode) %*% C %*% EdgeNode

#Weighted adjacency matrix
Adj <- matrix(c(c(0,0,sqrt(2),0,0,0),
                c(0,0,sqrt(2),0,0,0),
                c(sqrt(2),sqrt(2),0,sqrt(2),0,0),
                c(0,0,sqrt(2),0,sqrt(2),1),
                c(0,0,0,sqrt(2),0,1),
                c(0,0,0,1,1,0)
                ), nrow = 6)

#Injection vector of power put in and removed
InjectionVect <- c(10,20,0,-20,10,-20)
sum(InjectionVect)

InjectMat <- diag(InjectionVect)

abs(t(EdgeNode) %*% diag(1, nrow = nrow(EdgeNode)) %*% EdgeNode)

Adj <- (t(EdgeNode) %*% diag(1, nrow = nrow(EdgeNode)) %*% EdgeNode) / (t(EdgeNode) %*% diag(1, nrow = nrow(EdgeNode)) %*% EdgeNode) 
diag(Adj) <-0
Adj[!is.finite(Adj)] <-0
Adj

Zvect <- c(1,2,0,-1,-2,-2)

HeightDiff <- t(Adj * Zvect) - (Adj * Zvect) 
D <- t(EdgeNode) %*% C %*% EdgeNode %>% abs
diag(D) <-0

t(EdgeNode) %*% diag(1, nrow = nrow(EdgeNode)) %*% EdgeNode

EdgeNode %*% diag(Zvect, nrow = length(Zvect)) %*% t(EdgeNode)

C^2

Tension <- function(dZ,k, D){
  
  k*(sqrt(dZ^2+ D^2)-D)*dZ/(sqrt(dZ^2+ D^2))
  
}

kvect <- Link$k
dvect <- Link$distance

Create_Tension_matrix<- function(EdgeNode, zvect, kvect, dvect){
  #EdgeNode <- The edgenode matrix 
  #zvect the height of each node
  #kvect the vector of spring stiffness for each edge
  #dvect, the vector of horizontal distance between the springs.

  #Creat the adjacency matrix
  Adj <- (t(EdgeNode) %*% diag(1, nrow = nrow(EdgeNode)) %*% EdgeNode) / (t(EdgeNode) %*% diag(1, nrow = nrow(EdgeNode)) %*% EdgeNode) 
  diag(Adj) <-0
  Adj[!is.finite(Adj)] <-0
  Adj
  
  Zmat <- Adj*zvect #The adjacency matrix weight by node height
  dZmat <- Zmat- t(Zmat) #The difference in height between adjacent nodes
  #Create the absolute K (spring stiffness) a and distance matrices
  kmat <- t(EdgeNode) %*% diag(kvect, nrow = length(kvect)) %*% EdgeNode %>% abs 
  Dmat <- t(EdgeNode) %*% diag(dvect, nrow = length(kvect)) %*% EdgeNode %>% abs
  
  Hmat <- sqrt(dZmat^2 + Dmat^2)
  
  Ften_mat<- kmat*(Hmat-Dmat)*dZmat/Hmat
  Ften_mat[!is.finite(Ften_mat)] <-0
  
  return (Ften_mat)
}


SmallEdgeNode <- matrix(c(1,-1,0,
                   0,1,-1), nrow = 2, byrow = T)
Smallzvect <- c(2,-1,1)
Smallkvect <- c(3,4)
Smalldvect <- c(1,1)

Create_Tension_matrix(SmallEdgeNode, Smallzvect, Smallkvect, Smalldvect)

Create_Tension_matrix(SmallEdgeNode, Smallzvect, Smallkvect, Smalldvect) %>%
  rowSums()

Tension(3, 3, 1)

Tension(-2,4, 1)


3*(sqrt(10)-1)
2*(sqrt(5)-1)

3*(sqrt(10)-1)/sqrt(10)
2*(sqrt(5)-1)/sqrt(5)


3*3*(sqrt(10)-1)/sqrt(10)
4*2*(sqrt(5)-1)/sqrt(5)

```



```{r}

velocity <- function(u, a, t0, t1){
  #calculates the velocity of an object given and initial velocity an acceleration and time difference
  #u initial velocity
  #a acceleration
  #t0 initial time
  #t1 next time period
  
  return(u + a*(t1-t0))
}


distance <- function(z, v, a, t0, t1 ){
  #Calculates the total distance a node will be from the origin for a given time step
  #z, distance at current time
  #v velcoity at current time
  #a acceleration
  #t0 current time
  #t1 time at and of time step
  
  return(v*(t1-t0) + 0.5*a*(t1-t0) + z)
  
}



Calc_Damping_matrix<- function(EdgeNode, v_vect, kvect, mvect){
  #EdgeNode <- The edgenode matrix 
  #zvect the height of each node
  #kvect the vector of spring stiffness for each edge
  #dvect, the vector of horizontal distance between the springs.

  #Creat the adjacency matrix
  Adj <- (t(EdgeNode) %*% diag(1, nrow = nrow(EdgeNode)) %*% EdgeNode) / (t(EdgeNode) %*% diag(1, nrow = nrow(EdgeNode)) %*% EdgeNode) 
  diag(Adj) <-0
  Adj[!is.finite(Adj)] <-0
  Adj
  
  Vmat <- Adj*v_vect #The adjacency matrix weight by node height
  #Create the absolute K (spring stiffness) a and distance matrices
  kmat <- t(EdgeNode) %*% diag(kvect, nrow = length(kvect)) %*% EdgeNode %>% abs 
  
  Ften_mat<- 2*sqrt(kmat*mvect)*Vmat
  Ften_mat[!is.finite(Ften_mat)] <-0
  
  return((Ften_mat))
}

#MASS CAN'T BE ZERO!

NodeStatus <- tibble(node = 1:6, mass = 5, force = c(10,20,0,-20,10,-20), z = 0, 
       NetTension = 0, velocity = 0, 
       friction = 0.2*velocity,
       NetForce = NetTension-force +friction,
       acceleration = NetForce/mass,
       t = 0)


Calc_Damping_matrix(EdgeNode, NodeStatus2$velocity, kvect, rep(5,6)) %>% rowSums()


Calc_System_Dynamics <- function(NodeStatus, EdgeNode, kvect, dvect, tstep = 1, friction = 0.2){
  
NodeStatus2 <- NodeStatus %>%
  mutate(z = distance(z, velocity, acceleration, t0 = t, t1 = t + tstep),
         velocity = velocity(velocity, NodeStatus$acceleration, t, t + tstep),
         NetTension = Create_Tension_matrix(EdgeNode, z, kvect, dvect) %>% rowSums(),
         friction = Calc_Damping_matrix(EdgeNode, velocity, kvect, mass) %>% rowMeans(), #velocity*10,
         NetForce = force + NetTension - friction,
         acceleration = NetForce/mass,
         t = t + tstep)
  
  paste("acceleration", sum(abs(NodeStatus2$acceleration)), "velocity", sum(abs(NodeStatus2$velocity)))
  
  return(NodeStatus2)
  
}


Calc_System_Dynamics(NodeStatus, EdgeNode, kvect, dvect,  tstep = 0.1)


FindStabilSystem <- function(NodeStatus, EdgeNode, kvect, dvect,  tstep, maxIter = 1000, friction = 0.2){
  
  
  NodeList <- list(NodeStatus)
  
  for(n in 1:maxIter){
    
    
   # print(NodeList[[n]])
    temp <- NodeList[[n]] %>%
       Calc_System_Dynamics(., EdgeNode, kvect, dvect, tstep, friction)
      
    NodeList[[n + 1]] <- temp
    
  }
  
  #Are all yhr accellerations below tolerance?
  ProcessFinished<- sum(temp$acceleration<tol)==nrow(temp)

  return(NodeList)
  
}


test <-FindStabilSystem(NodeStatus, EdgeNode, kvect, dvect, tstep=0.1, maxIter = 200, friction = 10) %>%
  bind_rows()


test2 <- test %>% filter(node == 3)


ggplot(test2, aes(x = t, y = NetForce, colour = as.factor(node))) +
  geom_point()


test %>%
  group_by(t) %>%
  summarise(z = mean(abs(z)),
            NetForce = mean(abs(NetForce)),
            velocity = mean(abs(velocity))) %>%
  ggplot(aes(x = t, y =z )) + geom_line()

test  %>%
  mutate(node = factor(node)) %>%
  ggplot(aes(x = t, y =z , colour = node)) + geom_line()

test %>%
  filter(t == max(t)) %>%
  mutate(velocity = 0,
         friction = 0,
         NetForce = force + NetTension,
         #acceleration2 = acceleration,
         acceleration = NetForce/mass) %>% 
  FindStabilSystem(., EdgeNode, kvect, dvect, tstep=0.001, maxIter = 500, friction = 10) %>%
  bind_rows()  %>%
  filter(t == max(t))


test3 <- test %>%
  filter(t == median(t)) %>%
  

Calc_System_Dynamics(test3, EdgeNode, kvect, dvect,  tstep = 0.1)
Calc_Damping_matrix(EdgeNode, test3$velocity, kvect, rep(5,6) ) %>% rowSums()

SmallNodeStatus <- tibble(node = 1:3, mass = 5, force = c(10,0,-10), z = 0, 
       NetTension = 0, velocity = 0, 
       friction = 0,
       NetForce = force + NetTension +friction,
       acceleration = NetForce/mass,
       t = 0)

Smalltest <-FindStabilSystem(SmallNodeStatus, SmallEdgeNode, Smallkvect, Smalldvect, tstep=0.01, maxIter = 1000, friction = 2) %>%
  bind_rows()

Create_Tension_matrix(SmallEdgeNode, smallzvect , Smallkvect, Smalldvect)

Calc_Damping_matrix(SmallEdgeNode, Smalltest %>% filter(t == 1) %>% pull(velocity), Smallkvect, 
                    Smalltest %>% filter(t == 1) %>% pull(mass))

Smalltest %>%
  group_by(t) %>%
  summarise(z = mean(abs(z)),
            NetForce = mean(abs(NetForce)),
            velocity = mean(abs(velocity)),
            acceleration = mean(abs(acceleration))) %>%
  ggplot(aes(x = t, y =z )) + geom_line()


Smalltest  %>%
  mutate(node = factor(node)) %>%
  ggplot(aes(x = t, y =z , colour = node)) + geom_line()

```

