---
title: "Untitled"
author: "Jonathan Bourne"
date: "22 March 2019"
output: html_document
editor_options: 
  chunk_output_type: console
---



```{r}
library(tidyverse)

list.files("/home/jonno/Useful_PhD__R_Functions", pattern = "Tension", full.names = T) %>%
  walk(~source(.x))


theta_force <- seq(0,pi/2, 0.05 )


k = 300
dist <- sqrt(2)
force = 60
test <- tibble(Tension = force/sin(theta_force), adjacent = force/tan(theta_force), 
       opposite = force,
       elongation = Tension/k,
       theta_force = theta_force,
       theta_dist = acos(dist/(dist+elongation)),
       theta_diff = theta_force-theta_dist,
       height = sqrt((dist+ elongation)^2- dist^2))

test %>%
  arrange(abs(theta_diff)) %>% slice(1)

ggplot(test, aes(x = theta_force, y = theta_diff))+ geom_point()

```




```{r}
k1<- 2.5
k2 <- 3
F1<- 15
F2<- -25
F3 <- 10

D1 <- 1
D2 <-1.5
Dvect <- seq(0.01, 20, 0.001)

test <-tibble(z = Dvect, DX1 = sqrt(z^2 + D1^2)-D1, DX2 = sqrt(z^2 + D2^2)-D2, Ft1 = k1*DX1, Ft2 = k2*DX2, 
       F1u = Ft1*z/(DX1+D1), F2u = Ft2*z/(DX2+D2), difference = F1u+F2u+F3, min = abs(difference))


ggplot(test, aes(x = z, y = min))+ geom_point()


Fvect <- c(F1,-F3,F2)

test %>% arrange(min) %>% slice(1) %>% pull(z) %>% c(0,.,0) %>%
  tibble(ID  = 1:3, Fvect, height = -. ) %>%
  ggplot(., aes(x = ID, y = height)) + geom_point(size = 5) +
  geom_line()


EdgeNode <- c(1,-1,0,0,0,0,
              0,1,-1,0,0,0,
              0,0,0,1,-1,0,
              0,0,0,1,-1,0,
              0,0,0,0,1,-1,
              0,0,0,1,0,-1,
              0,1,0,0,-1,0
              ) %>% matrix(nrow = 7, byrow = T)

Link <- tibble(EdgeName = 1:7, 
               distance = c(sqrt(2), sqrt(2), sqrt(2), sqrt(2), 1,1, sqrt(2)),
               k = c(5,2,2.5,4,4,3,1))

  C <- matrix(data = 0, nrow = nrow(Link), ncol = nrow(Link))
  diag(C) <- Link$distance

#Injection vector of power put in and removed
InjectionVect <- c(10,20,0,-20,10,-20)
sum(InjectionVect)

InjectMat <- diag(InjectionVect)


Adj <- (t(EdgeNode) %*% diag(1, nrow = nrow(EdgeNode)) %*% EdgeNode) / (t(EdgeNode) %*% diag(1, nrow = nrow(EdgeNode)) %*% EdgeNode) 
diag(Adj) <-0
Adj[!is.finite(Adj)] <-0
Adj

graph_from_adjacency_matrix(Adj, mode = "undirected") %>% plot

Zvect <- c(1,2,0,-1,-2,-2)

HeightDiff <- t(Adj * Zvect) - (Adj * Zvect) 
D <- t(EdgeNode) %*% C %*% EdgeNode %>% abs
diag(D) <-0

# Tension <- function(dZ,k, D){
#   
#   k*(sqrt(dZ^2+ D^2)-D)*dZ/(sqrt(dZ^2+ D^2))
#   
# }

kvect <- Link$k
dvect <- Link$distance

SmallEdgeNode <- matrix(c(1,-1,0,
                   0,1,-1), nrow = 2, byrow = T)
Smallzvect <- c(2,-1,1)
Smallkvect <- c(3,4)
Smalldvect <- c(1,1)

Create_Tension_matrix(SmallEdgeNode, Smallzvect, Smallkvect, Smalldvect)

Create_Tension_matrix(SmallEdgeNode, Smallzvect, Smallkvect, Smalldvect) %>%
  rowSums()


Calc_Damping_matrix(SmallEdgeNode, 0, Smallkvect, 
                    c(5,5,5))

```



```{r}

velocity <- function(u, a, t0, t1){
  #calculates the velocity of an object given and initial velocity an acceleration and time difference
  #u initial velocity
  #a acceleration
  #t0 initial time
  #t1 next time period
  
  return(u + a*(t1-t0))
}


distance <- function(z, v, a, t0, t1 ){
  #Calculates the total distance a node will be from the origin for a given time step
  #z, distance at current time
  #v velcoity at current time
  #a acceleration
  #t0 current time
  #t1 time at and of time step
  
  return(v*(t1-t0) + 0.5*a*(t1-t0) + z)
  
}





#MASS CAN'T BE ZERO!

NodeStatus2 <- tibble(node = 1:6, mass = 5, force = c(10,20,0,-20,10,-20), z = 0, 
       NetTension = 0, velocity = 0, 
       friction = 0,
       NetForce = NetTension + force - friction,
       acceleration = NetForce/mass,
       t = 0)


Calc_Damping_matrix(EdgeNode, NodeStatus$velocity, kvect, rep(5,6)) %>% rowSums()


Calc_System_Dynamics <- function(NodeStatus, EdgeNode, kvect, dvect, tstep = 1, frctmultiplier = 1){
  
NodeStatus2 <- NodeStatus %>%
  mutate(z = distance(z, velocity, acceleration, t0 = t, t1 = t + tstep),
         velocity = velocity(velocity, acceleration, t, t + tstep),
         NetTension = Create_Tension_matrix(EdgeNode, z, kvect, dvect) %>% rowSums(),
         friction = Calc_Damping_matrix(EdgeNode, velocity, kvect, mass) %>% rowMeans()*frctmultiplier, #velocity*10,
         NetForce = force + NetTension - friction,
         acceleration = NetForce/mass,
         t = t + tstep)
  
  paste("acceleration", sum(abs(NodeStatus2$acceleration)), "velocity", sum(abs(NodeStatus2$velocity)))
  
  return(NodeStatus2)
  
}


Calc_System_Dynamics(NodeStatus2, EdgeNode, kvect, dvect,  tstep = 0.1)





FindStabilSystem2 <- function(NodeStatus, EdgeNode, kvect, dvect,  tstep, maxIter = 1000, frctmultiplier = 1){
  
  NodeList <- NodeStatus
  
  results <- as.list(rep(NA,maxIter))
  
  for(n in 1:maxIter){
    
    
   # print(NodeList[[n]])
    temp <- NodeList %>%
       Calc_System_Dynamics(., EdgeNode, kvect, dvect, tstep, frctmultiplier)
      
  results[[n]] <- temp %>%
  group_by(t) %>%
  summarise(z = mean(abs(z)),
            NetForce = mean(abs(NetForce)),
            velocity = mean(abs(velocity)),
            acceleration = mean(abs(acceleration))) %>%
    ungroup
    
    NodeList <- temp
    
  }
  
  #Are all yhr accellerations below tolerance?
  #ProcessFinished<- sum(temp$acceleration<tol)==nrow(temp)

  Out<- results %>% bind_rows() %>%
    list(., NodeList)
  
  names(Out) <- c("results", "NodeList")
  
  return(Out)
  
}


test <-FindStabilSystem(NodeStatus2, EdgeNode, kvect, dvect, tstep=0.1, maxIter = 200, frctmultiplier = 1) %>%
  bind_rows()


test2 <- test %>% filter(node == 3)


ggplot(test2, aes(x = t, y = acceleration)) +
  geom_line()


test %>%
  group_by(t) %>%
  summarise(z = mean(abs(z)),
            acceleration = mean(abs(acceleration)),
            NetForce = mean(abs(NetForce)),
            velocity = mean(abs(velocity))) %>%
  ggplot(aes(x = t, y =acceleration )) + geom_line()

test  %>%
  mutate(node = factor(node)) %>%
  ggplot(aes(x = t, y =z , colour = node)) + geom_line()

test %>%
  filter(t == max(t)) %>%
  mutate(velocity = 0,
         friction = 0,
         NetForce = force + NetTension,
         #acceleration2 = acceleration,
         acceleration = NetForce/mass) %>% 
  FindStabilSystem(., EdgeNode, kvect, dvect, tstep=0.001, maxIter = 500, friction = 10) %>%
  bind_rows()  %>%
  filter(t == max(t))


test3 <- test %>%
  filter(t == median(t)) %>%
  

Calc_System_Dynamics(test3, EdgeNode, kvect, dvect,  tstep = 0.1)
Calc_Damping_matrix(EdgeNode, test3$velocity, kvect, rep(5,6) ) %>% rowSums()

SmallNodeStatus <- tibble(node = 1:3, mass = 5, force = c(10,0,-10), z = 0, 
       NetTension = 0, velocity = 0, 
       friction = 0,
       NetForce = force + NetTension +friction,
       acceleration = NetForce/mass,
       t = 0)

Smalltest <-FindStabilSystem(SmallNodeStatus, SmallEdgeNode, Smallkvect, Smalldvect, tstep=0.01, maxIter = 10000, frctmultiplier = 0.01) %>%
  bind_rows()

Create_Tension_matrix(SmallEdgeNode, smallzvect , Smallkvect, Smalldvect)

Calc_Damping_matrix(SmallEdgeNode, Smalltest %>% filter(t == 1) %>% pull(velocity), Smallkvect, 
                    Smalltest %>% filter(t == 1) %>% pull(mass))

Smalltest %>%
  group_by(t) %>%
  summarise(z = mean(abs(z)),
            NetForce = mean(abs(NetForce)),
            velocity = mean(abs(velocity)),
            acceleration = mean(abs(acceleration))) %>%
  ggplot(aes(x = t, y =z )) + geom_line()


Smalltest  %>%
  mutate(node = factor(node)) %>%
  ggplot(aes(x = t, y =z , colour = node)) + geom_line()

```


#Test real graph

```{r}
#Create Edge matrix from graph

A <- as_data_frame(List_of_BiConComps[[147]]) %>% 
  select(Link, from, to) %>% 
  gather(key = type, Node, -Link) %>%
  arrange(Node) %>%
  mutate(value = ifelse(type =="from", 1, -1)) %>%
  ungroup %>%
  select(-type) %>%
  spread(key = Node, value, fill = 0) %>%
  arrange(Link)

rowdat <- A$Link

A <- A %>% select(-Link) %>%
  as.matrix()

rownames(rowdat)

rm(rowdat)


NodeStatus <- as_data_frame(List_of_BiConComps[[147]], what = "vertices") %>%
  select(node = name, force = BalencedPower ) %>%
  mutate(
    z = 0,
    mass = 2000,
    NetTension = 0, velocity = 0, 
       friction = 0,
       NetForce = force + NetTension - friction,
       acceleration = NetForce/mass,
       t = 0) %>%
  filter(!(node %in% deletenames))

NodeStatus$force %>% sum

testratio <- NodeStatus %>%
  mutate(ratio = abs(force/mass))


Link <- as_data_frame(g) %>%
  mutate(EdgeName = Link, distance = 1/Y, alpha = Link.Limit/abs(PowerFlow),  k= 1000*(1-1/alpha)) %>% #arbitary k!
  select(EdgeName, distance, k) 

test <-FindStabilSystem(NodeStatus, A, Link$k, Link$distance, tstep= 0.5, maxIter = 2000, frctmultiplier = 1) %>%
  bind_rows()

test <-FindStabilSystem2(NodeStatus, A, Link$k, Link$distance, tstep= 0.5, maxIter = 2000, frctmultiplier = 1) 



 test$results %>%
  ggplot(aes(x = t, y =z)) + geom_line()

test2 <- test$NodeList
 
summtest <- test %>%
  group_by(t) %>%
  summarise(z = mean(abs(z)),
            NetForce = mean(abs(NetForce)),
            velocity = mean(abs(velocity)),
            acceleration = mean(abs(acceleration))) 

summtest %>%
  ggplot(aes(x = t, y = z)) + geom_line()


testnode <- test %>%
  filter(node =="DUGR")

testnode %>%
  ggplot(aes(x = t, y = z )) + geom_line()


finalround <- test %>%
  filter(t == max(t))

#k1e4 <- test
#k10 <- test
#k100Iter2k <- test

test <- k1e4

```

#System dynamics MASS version

This version gives mass equak to force apart from transition nodes that are given the median mass.

```{r}

#mass version
Calc_System_Dynamics <- function(NodeStatus, EdgeNode, kvect, dvect, tstep = 1, frctmultiplier = 1){
  
NodeStatus2 <- NodeStatus %>%
  mutate(z = distance(z, velocity, acceleration, t0 = t, t1 = t + tstep),
         velocity = velocity(velocity, acceleration, t, t + tstep),
         NetTension = Create_Tension_matrix(EdgeNode, z, kvect, dvect) %>% rowSums(),
         friction = Calc_Damping_matrix(EdgeNode, velocity, kvect, abs(mass)) %>% rowMeans()*frctmultiplier, #velocity*10,
         NetForce = force + NetTension - friction,
         acceleration = NetForce/abs(mass),
         t = t + tstep)
  
  paste("acceleration", sum(abs(NodeStatus2$acceleration)), "velocity", sum(abs(NodeStatus2$velocity)))
  
  return(NodeStatus2)
  
}

baseAcceleration <- 10

NodeStatusMass <- as_data_frame(g, what = "vertices") %>%
  select(node = name, mass = BalencedPower ) %>%
  mutate(
    z = 0,
    basemass = -mass, #production is negative mass
    mass =ifelse(basemass==0, median(basemass), basemass), #effective mass is the mean mass, it exerts no force on the system
    force = mass*baseAcceleration,
    NetTension = 0, velocity = 0, 
       friction = 0,
       NetForce = force + NetTension - friction,
       acceleration = NetForce/abs(mass), #acceleration uses the effective mass for calculation
       t = 0)


NodeStatusMass %>%
  filter(node %in% c("DUGR", "ARMO", "EDIN"))


Link <- as_data_frame(g) %>%
  mutate(EdgeName = Link, distance = 1/Y, alpha = Link.Limit/abs(PowerFlow),  k= 100*(1-1/alpha)) %>% #arbitary k!
  select(EdgeName, distance, k) 

test <-FindStabilSystem(NodeStatusMass, A, Link$k, Link$distance, tstep= 0.02, maxIter = 200, frctmultiplier = 1) %>%
  bind_rows()



testnode <- test %>%
  #filter(node =="DUGR")
  filter(node %in% c("DUGR", "ARMO", "EDIN"))

testnode %>%
  ggplot(aes(x = t, y = z )) + geom_line()


```



```{r}

smallBi <- biconnected_components(graph_from_adjacency_matrix(Adj, mode = "undirected"))

smallBi$components[[1]] %>% length
  
bigraph <- biconnected_components(g)

bigraph %>% names

NodesPerComponent <- bigraph$components %>%
  map_dbl(~length(.x)) %>%
  tibble(components = 1:length(.), counts = .)


get_bicomp_power <- function(g, component_number){

  DeleteNodes <- get.vertex.attribute(g, "name")[!get.vertex.attribute(g, "name") %in% V(g)$name[bigraph$components[[component_number]]]]

  delete.vertices(g, DeleteNodes) %>% get.vertex.attribute(., "BalencedPower") %>% sum
}


BicompPower <- 1:length(bigraph$components) %>%
  map_df(~{
    
    tibble(BiComp = .x, Power = get_bicomp_power(g, .x))
    
  })

#create a sub graph that includes all the bicomponent of a node except the one that includes the active bi-comp



List_of_BiConComps <- Create_balanced_blocks(g)


List_of_BiConComps %>%
  map_dbl(~{
    
    get.vertex.attribute(.x, "BalencedPower") %>% sum
    
  })


List_of_BiConComps[[1]] %>% get.vertex.attribute(., "BalencedPower")

StabilModels <- 1:length(List_of_BiConComps) %>% 
  map(~{
    print(.x)
    
    Out <- Find_network_balance(List_of_BiConComps[[.x]])
    
    print(Out$results)
    return(Out)
    
    })

test <- Find_network_balance(List_of_BiConComps[[1]])


g <- List_of_BiConComps[[147]]
```

